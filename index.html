<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kynto Manager (Tasks Attachments)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #fff;
            --accent: #38bdf8;
            --status-todo: #f59e0b;
            --status-progress: #3b82f6;
            --status-done: #10b981;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a); color: var(--text-main); margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* Layout */
        .sidebar { width: 260px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border-right: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .project-list { list-style: none; padding: 0; flex-grow: 1; }
        .project-item { padding: 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #cbd5e1; display: flex; justify-content: space-between; }
        .project-item.active { background: rgba(56, 189, 248, 0.15); color: var(--accent); border-left: 3px solid var(--accent); }
        
        /* Kanban */
        .kanban-board { display: flex; gap: 20px; padding: 20px; height: 100%; overflow-x: auto; }
        .column { flex: 1; min-width: 300px; background: var(--glass-bg); border-radius: 12px; padding: 15px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .task-list { flex: 1; overflow-y: auto; min-height: 100px; }
        
        .card { background: #fff; color: #1e293b; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: grab; border-left: 4px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card:hover { transform: translateY(-2px); }
        .card[data-status="todo"] { border-left-color: var(--status-todo); }
        .card[data-status="progress"] { border-left-color: var(--status-progress); }
        .card[data-status="done"] { border-left-color: var(--status-done); }
        
        .card-icons { margin-top: 8px; display: flex; gap: 10px; font-size: 0.75rem; color: #64748b; }
        .icon-with-text { display: flex; align-items: center; gap: 4px; }

        /* Modal Tarefa */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #1e293b; width: 500px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 16px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 15px; }
        
        .form-input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: #fff; border-radius: 8px; }
        .btn-primary { background: var(--accent); color: #0f172a; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-google { background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; border: none; font-weight: 500; }
        
        /* Lista de Anexos dentro do Modal */
        .attachment-list { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .attachment-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .attachment-item a { color: var(--accent); text-decoration: none; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .attachment-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        .btn-delete-file { color: #ef4444; cursor: pointer; padding: 5px; }

        /* Utilitários */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color:var(--accent); margin-bottom:20px">Kynto Cloud</h2>
        <ul class="project-list" id="projectList"></ul>
        <button class="btn-primary" style="background:transparent; border:1px dashed #555; color:#aaa; width:100%" onclick="createNewProject()">+ Novo Projeto</button>
    </div>

    <div class="main-content">
        <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1)">
            <h2 id="currentProjectTitle" style="margin:0">Carregando...</h2>
        </div>

        <div class="kanban-board">
            <div class="column" id="col-todo">
                <h3>A Fazer</h3>
                <div class="task-list" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                <button class="btn-primary" style="margin-top:10px; width:100%" onclick="openTaskModal('todo')">+ Adicionar</button>
            </div>
            <div class="column" id="col-progress">
                <h3>Em Curso</h3>
                <div class="task-list" ondrop="drop(event, 'progress')" ondragover="allowDrop(event)"></div>
                <button class="btn-primary" style="margin-top:10px; width:100%" onclick="openTaskModal('progress')">+ Adicionar</button>
            </div>
            <div class="column" id="col-done">
                <h3>Concluído</h3>
                <div class="task-list" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                <button class="btn-primary" style="margin-top:10px; width:100%" onclick="openTaskModal('done')">+ Adicionar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h3 id="modalTitle" style="margin:0">Tarefa</h3>
                <span style="cursor:pointer; font-size:1.2rem" onclick="closeModal()">✕</span>
            </div>

            <label style="color:#aaa; font-size:0.8rem">Título</label>
            <input type="text" id="taskInput" class="form-input">

            <label style="color:#aaa; font-size:0.8rem">Data de Entrega</label>
            <input type="date" id="dateInput" class="form-input">

            <div id="attachmentsSection" class="hidden">
                <div style="height:1px; background:#334155; margin:15px 0"></div>
                <label style="color:#aaa; font-size:0.8rem; display:block; margin-bottom:10px">Anexos (Google Drive)</label>
                
                <button id="googleBtn" class="btn-google" onclick="loadGooglePicker()">
                    <i class="fa-brands fa-google-drive"></i> Anexar Arquivo
                </button>

                <div class="attachment-list" id="attachmentList">
                    </div>
            </div>
            
            <div id="saveFirstMsg" style="color:var(--status-todo); font-size:0.8rem; margin-top:10px; text-align:center">
                Salver a tarefa primeiro para adicionar anexos.
            </div>

            <input type="hidden" id="statusInput">
            <input type="hidden" id="editingTaskId">

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px">
                <button class="btn-primary" style="background:#ef4444" onclick="deleteCurrentTask()" id="btnDeleteTask">Excluir</button>
                <button class="btn-primary" onclick="confirmSaveTask()">Salvar</button>
            </div>
        </div>
    </div>

    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <script>
        // --- SUAS CHAVES AQUI ---
        const API_KEY = 'SUA_API_KEY_AQUI'; 
        const CLIENT_ID = 'SEU_CLIENT_ID_AQUI'; 
        const APP_ID = '';

        // --- ESTADO ---
        let projects = [], currentTasks = [], currentFiles = [];
        let currentProjectId = null;
        let accessToken = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await initApp();
            setTimeout(initGoogle, 1000);
        });

        async function initApp() {
            try {
                const res = await fetch('/api/projects');
                if(!res.ok) throw new Error();
                projects = await res.json();
                renderProjectList();
                if(projects.length) loadProject(projects[0].id, projects[0].name);
                else document.getElementById('currentProjectTitle').innerText = "Crie um projeto...";
            } catch(e) { console.log("Erro carregando app"); }
        }

        function initGoogle() {
            if(API_KEY.includes('SUA_')) return;
            try {
                gapi.load('client:picker', () => {});
                google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: (r) => { accessToken = r.access_token; createPicker(); }
                });
            } catch(e){}
        }

        // --- CORE ---
        async function loadProject(id, name) {
            currentProjectId = id;
            document.getElementById('currentProjectTitle').innerText = name;
            renderProjectList();
            
            const [t, f] = await Promise.all([
                fetch(`/api/tasks?projectId=${id}`), fetch(`/api/files?projectId=${id}`)
            ]);
            currentTasks = await t.json();
            currentFiles = await f.json();
            renderKanban();
        }

        function renderKanban() {
            ['todo', 'progress', 'done'].forEach(s => {
                const list = document.querySelector(`#col-${s} .task-list`);
                list.innerHTML = '';
                const tasks = currentTasks.filter(t => t.status === s);
                
                tasks.forEach(t => {
                    // Verifica quantos arquivos essa tarefa tem
                    const taskFiles = currentFiles.filter(f => f.task_id == t.id);
                    const hasFiles = taskFiles.length > 0;

                    const card = document.createElement('div');
                    card.className = 'card'; card.draggable = true;
                    card.setAttribute('data-status', s);
                    
                    card.innerHTML = `
                        <div style="font-weight:500">${t.title}</div>
                        <div class="card-icons">
                            ${t.due_date ? `<div class="icon-with-text"><i class="fa-regular fa-clock"></i> ${formatDate(t.due_date)}</div>` : ''}
                            ${hasFiles ? `<div class="icon-with-text"><i class="fa-solid fa-paperclip"></i> ${taskFiles.length}</div>` : ''}
                        </div>
                    `;
                    
                    card.onclick = () => openTaskModal(s, t);
                    card.ondragstart = (ev) => ev.dataTransfer.setData("text/plain", t.id.toString());
                    list.appendChild(card);
                });
            });
        }

        // --- MODAL & ANEXOS ---
        function openTaskModal(status, task = null) {
            document.getElementById('taskModal').style.display = 'flex';
            document.getElementById('statusInput').value = status;
            
            const attachSection = document.getElementById('attachmentsSection');
            const saveFirstMsg = document.getElementById('saveFirstMsg');
            const deleteBtn = document.getElementById('btnDeleteTask');

            if(task) {
                // EDITAR (Pode anexar)
                document.getElementById('modalTitle').innerText = "Editar Tarefa";
                document.getElementById('taskInput').value = task.title;
                document.getElementById('dateInput').value = task.due_date;
                document.getElementById('editingTaskId').value = task.id;
                
                attachSection.classList.remove('hidden');
                saveFirstMsg.classList.add('hidden');
                deleteBtn.classList.remove('hidden');

                renderAttachmentList(task.id);
            } else {
                // NOVA (Não pode anexar ainda)
                document.getElementById('modalTitle').innerText = "Nova Tarefa";
                document.getElementById('taskInput').value = "";
                document.getElementById('dateInput').value = "";
                document.getElementById('editingTaskId').value = "";
                
                attachSection.classList.add('hidden');
                saveFirstMsg.classList.remove('hidden');
                deleteBtn.classList.add('hidden');
            }
        }

        function renderAttachmentList(taskId) {
            const list = document.getElementById('attachmentList');
            list.innerHTML = '';
            
            const files = currentFiles.filter(f => f.task_id == taskId);
            
            files.forEach(f => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                // Ícone ou Thumbnail
                let icon = '<i class="fa-solid fa-file"></i>';
                if(f.type === 'image') icon = `<i class="fa-solid fa-image"></i>`;
                
                item.innerHTML = `
                    ${icon}
                    <a href="${f.url}" target="_blank">${f.name}</a>
                    <i class="fa-solid fa-trash btn-delete-file" onclick="deleteFile(${f.id})"></i>
                `;
                list.appendChild(item);
            });
        }

        async function confirmSaveTask() {
            const id = document.getElementById('editingTaskId').value;
            const title = document.getElementById('taskInput').value;
            const date = document.getElementById('dateInput').value;
            const status = document.getElementById('statusInput').value;
            
            if(!title) return alert("Digite um título");

            const body = { id, title, date, status, projectId: currentProjectId };
            const method = id ? 'PUT' : 'POST';
            
            await fetch('/api/tasks', { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
            closeModal();
            loadProject(currentProjectId, document.getElementById('currentProjectTitle').innerText);
        }

        async function deleteCurrentTask() {
            const id = document.getElementById('editingTaskId').value;
            if(id && confirm("Excluir tarefa e anexos?")) {
                await fetch(`/api/tasks?id=${id}`, { method: 'DELETE' });
                closeModal();
                loadProject(currentProjectId, document.getElementById('currentProjectTitle').innerText);
            }
        }

        // --- GOOGLE PICKER ---
        function loadGooglePicker() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (r) => { accessToken = r.access_token; createPicker(); }
            });
            client.requestAccessToken();
        }

        function createPicker() {
            const view = new google.picker.View(google.picker.ViewId.DOCS);
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN).setDeveloperKey(API_KEY).setAppId(APP_ID)
                .setOAuthToken(accessToken).addView(view)
                .setCallback(pickerCallback).build();
            picker.setVisible(true);
        }

        async function pickerCallback(data) {
            if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                const doc = data[google.picker.Response.DOCUMENTS][0];
                const taskId = document.getElementById('editingTaskId').value;
                
                // Salvar arquivo vinculado à tarefa
                await fetch('/api/files', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ 
                        projectId: currentProjectId, 
                        task_id: taskId, // IMPORTANTE: Vincula à tarefa
                        name: doc.name, 
                        url: doc.url, 
                        type: doc.type === 'photo' ? 'image' : 'file' 
                    })
                });
                
                // Recarrega lista de arquivos localmente
                const fRes = await fetch(`/api/files?projectId=${currentProjectId}`);
                currentFiles = await fRes.json();
                renderAttachmentList(taskId);
            }
        }

        // --- UTILS ---
        async function deleteFile(id) {
            if(confirm("Remover anexo?")) {
                await fetch(`/api/files?id=${id}`, {method:'DELETE'});
                const fRes = await fetch(`/api/files?projectId=${currentProjectId}`);
                currentFiles = await fRes.json();
                renderAttachmentList(document.getElementById('editingTaskId').value);
            }
        }
        
        function allowDrop(e){e.preventDefault();}
        async function drop(e,s){e.preventDefault();const id=e.dataTransfer.getData("text/plain");if(id){await fetch('/api/tasks',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,status:s})});loadProject(currentProjectId,document.getElementById('currentProjectTitle').innerText);}}
        function renderProjectList(){const l=document.getElementById('projectList');l.innerHTML='';projects.forEach(p=>{const li=document.createElement('li');li.className=`project-item ${p.id==currentProjectId?'active':''}`;li.innerHTML=`<span>${p.name}</span>`;li.onclick=()=>loadProject(p.id,p.name);l.appendChild(li);});}
        async function createNewProject(){const n=prompt("Nome:");if(n){await fetch('/api/projects',{method:'POST',body:JSON.stringify({name:n})});location.reload();}}
        function closeModal(){document.getElementById('taskModal').style.display='none';}
        function formatDate(s){if(!s)return'';const[y,m,d]=s.split('-');return`${d}/${m}`;}

    </script>
</body>
</html>
